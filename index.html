// server.js
import express from 'express';
import path from 'path';
import { fileURLToPath } from 'url';

const app = express();
const PORT = process.env.PORT || 10000; // Render uses PORT env variable

// To get __dirname in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Serve static files from /opt/render/project/src/public if you have assets
app.use(express.static(path.join('/opt/render/project/src', 'public')));

// Route to render the checkout page dynamically
app.get('/checkout', (req, res) => {
  const { item = "Unknown Item", price = "0.00", mode = "N/A", type = "N/A" } = req.query;

  const capitalize = (str) => str ? str.charAt(0).toUpperCase() + str.slice(1) : "";

  res.send(`
  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ArkadiaSMP Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { font-family: "Inter", sans-serif; background-color: #0d1117; color: #fff; }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen p-4">

    <div class="max-w-lg w-full bg-gray-800 rounded-xl shadow-xl p-6 text-center">
      <h1 class="text-3xl font-extrabold text-purple-400 mb-3">ArkadiaSMP Checkout</h1>
      <p class="text-gray-400 mb-6">Secure payments via PayPal or Card</p>

      <div id="summary" class="bg-gray-700 rounded-lg p-4 mb-6 text-left">
        <p><span class="text-gray-400">Item:</span> <span id="item-name" class="font-semibold text-white">${item}</span></p>
        <p><span class="text-gray-400">Mode / Type:</span> <span id="item-mode-type" class="font-semibold text-white">${capitalize(mode)} / ${capitalize(type)}</span></p>
        <p class="border-t border-gray-600 mt-3 pt-3 text-lg">
          <span class="font-bold">Price:</span>
          <span id="item-price" class="font-extrabold text-green-400">¬£${parseFloat(price).toFixed(2)}</span>
        </p>
      </div>

      <div id="paypal-button-container"></div>
      <div id="message" class="mt-6 text-green-400 font-semibold"></div>
    </div>

    <script src="https://www.paypal.com/sdk/js?client-id=Acnf7G5kNf-TQfeMQe77weOfypeR9iqIcEZs1j7smHsKFklZcPTTDT_7s2qRLY6RmsCRz0deONuaJNwH&currency=GBP&components=buttons,funding-eligibility&enable-funding=card,paylater"></script>

    <script>
      const itemName = "${item}";
      const itemMode = "${capitalize(mode)}";
      const itemType = "${capitalize(type)}";
      const itemPrice = "${parseFloat(price).toFixed(2)}";

      paypal.Buttons({
        style: { layout: 'vertical', color: 'gold', shape: 'pill', label: 'paypal' },
        createOrder: (data, actions) => {
          return actions.order.create({
            purchase_units: [{
              description: \`\${itemName} (\${itemMode}/\${itemType})\`,
              amount: { currency_code: 'GBP', value: itemPrice }
            }]
          });
        },
        onApprove: (data, actions) => {
          return actions.order.capture().then(details => {
            const payer = details.payer.name.given_name;
            document.getElementById("message").innerHTML =
              \`üéâ Thanks, <b>\${payer}</b>! Your payment for <b>\${itemName}</b> was successful.\`;
          });
        },
        onError: (err) => {
          console.error('PayPal Error:', err);
          document.getElementById("message").innerHTML =
            "‚ö†Ô∏è Payment failed. Please try again.";
        }
      }).render('#paypal-button-container');
    </script>
  </body>
  </html>
  `);
});

// Start server
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
